{% extends 'main/base.html' %}
{% load static %}

{% block title %}Applications for {{ opportunity }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Applications for: {{ opportunity.company.company_name }} - {{ opportunity.city.arabic_name }}</h3>
    <p><strong>Deadline:</strong> {{ opportunity.application_deadline|date:"Y-m-d" }} | <strong>Status:</strong> {{ opportunity.get_status_display }}</p>
    <hr>

     {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% if applications %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Applicant</th>
                    <th>Applied At</th>
                    <th>Current Status</th>
                    <th>Actions</th>
                    <th>Chat</th> {# Added Chat Column #}
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                    <tr>
                        <td>
                            {% if app.student.personal_info.full_name %}
                               {{ app.student.personal_info.full_name }}
                            {% else %}
                                {{ app.student.user.username }}
                            {% endif %}
                            <br><small>{{ app.student.user.email }}</small>
                        </td>
                        <td>{{ app.applied_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ app.get_status_display }}</td>
                        <td>
                            {% if app.status != 'WITHDRAWN' %} {# Don't allow update if withdrawn #}
                                <form action="{% url 'posts:update_application_status' app.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <div class="input-group input-group-sm">
                                        <select name="status" class="form-select form-select-sm">
                                            {% for value, label in statuses %}
                                                {% if value != 'WITHDRAWN' %} {# Exclude withdrawn as company choice #}
                                                    <option value="{{ value }}" {% if app.status == value %}selected{% endif %}>{{ label }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                                    </div>
                                </form>
                            {% else %}
                                <span class="text-muted">Withdrawn by student</span>
                            {% endif %}
                        </td>
                         <td> {# Chat Button #}
                             <a href="{% url 'posts:application_chat' app.id %}" class="btn btn-sm btn-outline-secondary">Chat</a>
                         </td>
                    </tr>
                    {% if app.message %}
                    <tr class="table-light">
                       <td colspan="5"><small><strong>Applicant Message:</strong> {{ app.message|linebreaksbr }}</small></td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No applications received for this opportunity yet.</p>
    {% endif %}
     <a href="{% url 'posts:company_dashboard' %}" class="btn btn-secondary mt-3">Back to Dashboard</a>
</div>
{% endblock %}